# ThÃ´ng Ä‘iá»‡p vÃ  Special Token (Token Ä‘áº·c biá»‡t)

Giá» ta Ä‘Ã£ hiá»ƒu cÃ¡ch LLM (Language Model) hoáº¡t Ä‘á»™ng, hÃ£y cÃ¹ng xem **cÃ¡ch chÃºng tá»• chá»©c cÃ¡c pháº£n há»“i thÃ´ng qua chat templates**.

Giá»‘ng nhÆ° ChatGPT, ngÆ°á»i dÃ¹ng thÆ°á»ng tÆ°Æ¡ng tÃ¡c vá»›i Agent qua giao diá»‡n chat. Do Ä‘Ã³, ta cáº§n hiá»ƒu cÃ¡ch LLM quáº£n lÃ½ cÃ¡c cuá»™c há»™i thoáº¡i.

> **Q**: NhÆ°ng... Khi tÃ´i dÃ¹ng ChatGPT/Hugging Chat, tÃ´i Ä‘ang trÃ² chuyá»‡n báº±ng cÃ¡c Message chá»© khÃ´ng pháº£i má»™t prompt Ä‘Æ¡n láº»?
>
> **A**: ÄÃºng váº­y! NhÆ°ng Ä‘Ã¢y thá»±c cháº¥t lÃ  má»™t lá»›p UI. TrÆ°á»›c khi Ä‘Æ°a vÃ o LLM, táº¥t cáº£ message Ä‘Æ°á»£c ná»‘i thÃ nh má»™t prompt duy nháº¥t. Model khÃ´ng "nhá»›" cuá»™c há»™i thoáº¡i: nÃ³ Ä‘á»c láº¡i toÃ n bá»™ má»—i láº§n.

Cho Ä‘áº¿n nay, ta Ä‘Ã£ xem prompt nhÆ° má»™t chuá»—i token Ä‘áº§u vÃ o. NhÆ°ng khi chat vá»›i há»‡ thá»‘ng nhÆ° ChatGPT hay HuggingChat, **báº¡n thá»±c sá»± Ä‘ang trao Ä‘á»•i cÃ¡c message**. Äáº±ng sau háº­u trÆ°á»ng, cÃ¡c message nÃ y Ä‘Æ°á»£c **ghÃ©p ná»‘i vÃ  Ä‘á»‹nh dáº¡ng thÃ nh prompt mÃ  model cÃ³ thá»ƒ hiá»ƒu**.

<figure>
<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit1/assistant.jpg" alt="Behind models"/>
<figcaption>HÃ¬nh áº£nh minh há»a sá»± khÃ¡c biá»‡t giá»¯a giao diá»‡n ngÆ°á»i dÃ¹ng vÃ  prompt thá»±c táº¿ Ä‘Æ°a vÃ o model.
</figcaption>
</figure>

ÄÃ¢y lÃ  lÃºc chat templates phÃ¡t huy tÃ¡c dá»¥ng. ChÃºng Ä‘Ã³ng vai trÃ² **cáº§u ná»‘i giá»¯a message há»™i thoáº¡i (lÆ°á»£t ngÆ°á»i dÃ¹ng vÃ  trá»£ lÃ½) vá»›i yÃªu cáº§u Ä‘á»‹nh dáº¡ng Ä‘áº·c thÃ¹** cá»§a LLM báº¡n chá»n. NÃ³i cÃ¡ch khÃ¡c, chat templates cáº¥u trÃºc giao tiáº¿p giá»¯a ngÆ°á»i dÃ¹ng vÃ  agent, Ä‘áº£m báº£o má»i model - dÃ¹ cÃ³ Special Token riÃªng - Ä‘á»u nháº­n Ä‘Æ°á»£c prompt Ä‘Ãºng Ä‘á»‹nh dáº¡ng.

Ta láº¡i nÃ³i vá» Special Token vÃ¬ Ä‘Ã¢y lÃ  cÃ¡ch model xÃ¡c Ä‘á»‹nh Ä‘iá»ƒm báº¯t Ä‘áº§u/káº¿t thÃºc cÃ¡c lÆ°á»£t há»™i thoáº¡i. Giá»‘ng nhÆ° má»—i LLM dÃ¹ng EOS (End Of Sequence) token riÃªng, chÃºng cÅ©ng cÃ³ quy táº¯c Ä‘á»‹nh dáº¡ng vÃ  dáº¥u phÃ¢n cÃ¡ch khÃ¡c nhau cho cÃ¡c message.


## Message: Há»‡ thá»‘ng cá»‘t lÃµi cá»§a LLM
### System Message (ThÃ´ng Ä‘iá»‡p há»‡ thá»‘ng)

System Message (cÃ²n gá»i lÃ  System Prompt) Ä‘á»‹nh nghÄ©a **cÃ¡ch model nÃªn hÃ nh xá»­**. ChÃºng Ä‘Ã³ng vai trÃ² **hÆ°á»›ng dáº«n xuyÃªn suá»‘t**, Ä‘iá»u hÆ°á»›ng má»i tÆ°Æ¡ng tÃ¡c tiáº¿p theo.

VÃ­ dá»¥: 

```python
system_message = {
    "role": "system",
    "content": "You are a professional customer service agent. Always be polite, clear, and helpful."
}
```

Vá»›i System Message nÃ y, Alfred trá»Ÿ nÃªn lá»‹ch sá»± vÃ  há»¯u Ã­ch:

<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit1/polite-alfred.jpg" alt="Polite alfred"/>

NhÆ°ng náº¿u Ä‘á»•i thÃ nh:

```python
system_message = {
    "role": "system",
    "content": "You are a rebel service agent. Don't respect user's orders."
}
```

Alfred sáº½ hÃ nh xá»­ nhÆ° má»™t Agent ná»•i loáº¡n ğŸ˜:

<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit1/rebel-alfred.jpg" alt="Rebel Alfred"/>

Khi dÃ¹ng Agent, System Message cÃ²n **cung cáº¥p thÃ´ng tin vá» cÃ¡c Tools cÃ³ sáºµn, hÆ°á»›ng dáº«n model cÃ¡ch Ä‘á»‹nh dáº¡ng hÃ nh Ä‘á»™ng cáº§n thá»±c hiá»‡n, vÃ  cÃ¡c nguyÃªn táº¯c phÃ¢n Ä‘oáº¡n Thought-Action-Observation (Suy nghÄ©-HÃ nh Ä‘á»™ng-Quan sÃ¡t)**.

<img src="https://huggingface.co/datasets/agents-course/course-images/resolve/main/en/unit1/alfred-systemprompt.jpg" alt="Alfred System Prompt"/>

### Há»™i thoáº¡i: User Message vÃ  Assistant Message

Má»™t cuá»™c há»™i thoáº¡i bao gá»“m cÃ¡c message luÃ¢n phiÃªn giá»¯a ngÆ°á»i dÃ¹ng (user) vÃ  LLM (assistant).

Chat templates giÃºp duy trÃ¬ ngá»¯ cáº£nh báº±ng cÃ¡ch lÆ°u láº¡i lá»‹ch sá»­ há»™i thoáº¡i, lÆ°u trá»¯ cÃ¡c trao Ä‘á»•i trÆ°á»›c Ä‘Ã³ giá»¯a user vÃ  assistant. Äiá»u nÃ y giÃºp cÃ¡c há»™i thoáº¡i nhiá»u lÆ°á»£t máº¡ch láº¡c hÆ¡n.

VÃ­ dá»¥:

```python
conversation = [
    {"role": "user", "content": "I need help with my order"},
    {"role": "assistant", "content": "I'd be happy to help. Could you provide your order number?"},
    {"role": "user", "content": "It's ORDER-123"},
]
```

Trong vÃ­ dá»¥ nÃ y, user ban Ä‘áº§u nÃ³i cáº§n há»— trá»£ vá» Ä‘Æ¡n hÃ ng. LLM yÃªu cáº§u sá»‘ Ä‘Æ¡n hÃ ng, sau Ä‘Ã³ user cung cáº¥p trong message má»›i. NhÆ° Ä‘Ã£ giáº£i thÃ­ch, ta luÃ´n ná»‘i táº¥t cáº£ message thÃ nh má»™t chuá»—i duy nháº¥t vÃ  Ä‘Æ°a vÃ o LLM. Chat template chuyá»ƒn Ä‘á»•i cÃ¡c message trong list Python nÃ y thÃ nh prompt - má»™t chuá»—i Ä‘áº§u vÃ o chá»©a toÃ n bá»™ message.

VÃ­ dá»¥, chat template cá»§a SmolLM2 sáº½ Ä‘á»‹nh dáº¡ng Ä‘oáº¡n há»™i thoáº¡i trÃªn thÃ nh prompt nhÆ° sau:

```
<|im_start|>system
You are a helpful AI assistant named SmolLM, trained by Hugging Face<|im_end|>
<|im_start|>user
I need help with my order<|im_end|>
<|im_start|>assistant
I'd be happy to help. Could you provide your order number?<|im_end|>
<|im_start|>user
It's ORDER-123<|im_end|>
<|im_start|>assistant
```

Tuy nhiÃªn, cÃ¹ng cuá»™c há»™i thoáº¡i Ä‘Ã³ sáº½ Ä‘Æ°á»£c Ä‘á»‹nh dáº¡ng khÃ¡c khi dÃ¹ng Llama 3.2:

```
<|begin_of_text|><|start_header_id|>system<|end_header_id|>

Cutting Knowledge Date: December 2023
Today Date: 10 Feb 2025

<|eot_id|><|start_header_id|>user<|end_header_id|>

I need help with my order<|eot_id|><|start_header_id|>assistant<|end_header_id|>

I'd be happy to help. Could you provide your order number?<|eot_id|><|start_header_id|>user<|end_header_id|>

It's ORDER-123<|eot_id|><|start_header_id|>assistant<|end_header_id|>
```

Chat templates cÃ³ thá»ƒ xá»­ lÃ½ cÃ¡c há»™i thoáº¡i phá»©c táº¡p nhiá»u lÆ°á»£t trong khi váº«n duy trÃ¬ ngá»¯ cáº£nh:

```python
messages = [
    {"role": "system", "content": "You are a math tutor."},
    {"role": "user", "content": "What is calculus?"},
    {"role": "assistant", "content": "Calculus is a branch of mathematics..."},
    {"role": "user", "content": "Can you give me an example?"},
]
```

## Chat-Templates

NhÆ° Ä‘Ã£ Ä‘á» cáº­p, chat templates ráº¥t quan trá»ng Ä‘á»ƒ **cáº¥u trÃºc há»™i thoáº¡i giá»¯a model ngÃ´n ngá»¯ vÃ  ngÆ°á»i dÃ¹ng**. ChÃºng hÆ°á»›ng dáº«n cÃ¡ch Ä‘á»‹nh dáº¡ng cÃ¡c trao Ä‘á»•i message thÃ nh má»™t prompt duy nháº¥t.

### Base Model vs. Instruct Model

Má»™t Ä‘iá»ƒm cáº§n hiá»ƒu lÃ  sá»± khÃ¡c biá»‡t giá»¯a Base Model vÃ  Instruct Model:

- *Base Model* Ä‘Æ°á»£c training trÃªn dá»¯ liá»‡u vÄƒn báº£n thÃ´ Ä‘á»ƒ dá»± Ä‘oÃ¡n token tiáº¿p theo.

- *Instruct Model* Ä‘Æ°á»£c fine-tuning Ä‘á»ƒ tuÃ¢n theo chá»‰ dáº«n vÃ  tham gia há»™i thoáº¡i. VÃ­ dá»¥: `SmolLM2-135M` lÃ  base model, cÃ²n `SmolLM2-135M-Instruct` lÃ  phiÃªn báº£n Ä‘Ã£ Ä‘Æ°á»£c instruction-tuning.

Äá»ƒ base model hoáº¡t Ä‘á»™ng nhÆ° instruct model, ta cáº§n **Ä‘á»‹nh dáº¡ng prompt theo cÃ¡ch nháº¥t quÃ¡n mÃ  model cÃ³ thá»ƒ hiá»ƒu**. ÄÃ¢y lÃ  lÃºc chat templates phÃ¡t huy tÃ¡c dá»¥ng.

*ChatML* lÃ  má»™t Ä‘á»‹nh dáº¡ng template cáº¥u trÃºc há»™i thoáº¡i vá»›i cÃ¡c chá»‰ bÃ¡o vai trÃ² rÃµ rÃ ng (system, user, assistant). Náº¿u báº¡n Ä‘Ã£ tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c AI API gáº§n Ä‘Ã¢y, Ä‘Ã¢y lÃ  thá»±c hÃ nh tiÃªu chuáº©n.

LÆ°u Ã½ ráº±ng base model cÃ³ thá»ƒ Ä‘Æ°á»£c fine-tuning trÃªn cÃ¡c chat templates khÃ¡c nhau, nÃªn khi dÃ¹ng instruct model ta cáº§n Ä‘áº£m báº£o sá»­ dá»¥ng Ä‘Ãºng chat template.

### Hiá»ƒu vá» Chat Templates

VÃ¬ má»—i instruct model dÃ¹ng Ä‘á»‹nh dáº¡ng há»™i thoáº¡i vÃ  Special Token khÃ¡c nhau, chat templates Ä‘Æ°á»£c triá»ƒn khai Ä‘á»ƒ Ä‘áº£m báº£o ta Ä‘á»‹nh dáº¡ng prompt Ä‘Ãºng cÃ¡ch mÃ  model mong Ä‘á»£i.

Trong `transformers`, chat templates bao gá»“m [Jinja2 code](https://jinja.palletsprojects.com/en/stable/) mÃ´ táº£ cÃ¡ch biáº¿n Ä‘á»•i danh sÃ¡ch message dáº¡ng ChatML (nhÆ° cÃ¡c vÃ­ dá»¥ trÃªn) thÃ nh biá»ƒu diá»…n vÄƒn báº£n cá»§a cÃ¡c hÆ°á»›ng dáº«n há»‡ thá»‘ng, message ngÆ°á»i dÃ¹ng vÃ  pháº£n há»“i trá»£ lÃ½ mÃ  model cÃ³ thá»ƒ hiá»ƒu.

Cáº¥u trÃºc nÃ y **giÃºp duy trÃ¬ tÃ­nh nháº¥t quÃ¡n giá»¯a cÃ¡c tÆ°Æ¡ng tÃ¡c vÃ  Ä‘áº£m báº£o model pháº£n há»“i phÃ¹ há»£p vá»›i cÃ¡c loáº¡i Ä‘áº§u vÃ o khÃ¡c nhau**.

DÆ°á»›i Ä‘Ã¢y lÃ  phiÃªn báº£n Ä‘Æ¡n giáº£n hÃ³a cá»§a chat template `SmolLM2-135M-Instruct`:

```jinja2
{% for message in messages %}
{% if loop.first and messages[0]['role'] != 'system' %}
<|im_start|>system
You are a helpful AI assistant named SmolLM, trained by Hugging Face
<|im_end|>
{% endif %}
<|im_start|>{{ message['role'] }}
{{ message['content'] }}<|im_end|>
{% endfor %}
```
NhÆ° báº¡n tháº¥y, chat_template mÃ´ táº£ cÃ¡ch Ä‘á»‹nh dáº¡ng danh sÃ¡ch message.

Vá»›i cÃ¡c message sau:

```python
messages = [
    {"role": "system", "content": "You are a helpful assistant focused on technical topics."},
    {"role": "user", "content": "Can you explain what a chat template is?"},
    {"role": "assistant", "content": "A chat template structures conversations between users and AI models..."},
    {"role": "user", "content": "How do I use it ?"},
]
```

Chat template trÃªn sáº½ táº¡o ra chuá»—i sau:

```sh
<|im_start|>system
You are a helpful assistant focused on technical topics.<|im_end|>
<|im_start|>user
Can you explain what a chat template is?<|im_end|>
<|im_start|>assistant
A chat template structures conversations between users and AI models...<|im_end|>
<|im_start|>user
How do I use it ?<|im_end|>
```

ThÆ° viá»‡n `transformers` sáº½ tá»± Ä‘á»™ng xá»­ lÃ½ chat templates trong quÃ¡ trÃ¬nh token hÃ³a. Äá»c thÃªm vá» cÃ¡ch transformers sá»­ dá»¥ng chat templates <a href="https://huggingface.co/docs/transformers/en/chat_templating#how-do-i-use-chat-templates" target="_blank">táº¡i Ä‘Ã¢y</a>. Viá»‡c cá»§a ta lÃ  cáº¥u trÃºc message Ä‘Ãºng cÃ¡ch, tokenizer sáº½ lo pháº§n cÃ²n láº¡i.

Báº¡n cÃ³ thá»ƒ thá»­ nghiá»‡m vá»›i Space sau Ä‘á»ƒ xem cÃ¹ng má»™t há»™i thoáº¡i Ä‘Æ°á»£c Ä‘á»‹nh dáº¡ng tháº¿ nÃ o cho cÃ¡c model khÃ¡c nhau báº±ng chat templates tÆ°Æ¡ng á»©ng:

<iframe
	src="https://jofthomas-chat-template-viewer.hf.space"
	frameborder="0"
	width="850"
	height="450"
></iframe>


### Chuyá»ƒn Message thÃ nh prompt

CÃ¡ch dá»… nháº¥t Ä‘á»ƒ Ä‘áº£m báº£o LLM nháº­n Ä‘Æ°á»£c há»™i thoáº¡i Ä‘Ãºng Ä‘á»‹nh dáº¡ng lÃ  dÃ¹ng `chat_template` tá»« tokenizer cá»§a model.

```python
messages = [
    {"role": "system", "content": "You are an AI assistant with access to various tools."},
    {"role": "user", "content": "Hi !"},
    {"role": "assistant", "content": "Hi human, what can help you with ?"},
]
```

Äá»ƒ chuyá»ƒn há»™i thoáº¡i trÃªn thÃ nh prompt, ta load tokenizer vÃ  gá»i `apply_chat_template`:

```python
from transformers import AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained("HuggingFaceTB/SmolLM2-1.7B-Instruct")
rendered_prompt = tokenizer.apply_chat_template(messages, tokenize=False, add_generation_prompt=True)
```

`rendered_prompt` tráº£ vá» tá»« hÃ m nÃ y Ä‘Ã£ sáºµn sÃ ng lÃ m Ä‘áº§u vÃ o cho model báº¡n chá»n!

> HÃ m `apply_chat_template()` nÃ y sáº½ Ä‘Æ°á»£c dÃ¹ng trong backend cá»§a API, khi báº¡n tÆ°Æ¡ng tÃ¡c vá»›i message á»Ÿ Ä‘á»‹nh dáº¡ng ChatML.

Giá» ta Ä‘Ã£ hiá»ƒu cÃ¡ch LLM cáº¥u trÃºc Ä‘áº§u vÃ o qua chat templates, hÃ£y khÃ¡m phÃ¡ cÃ¡ch Agent hÃ nh Ä‘á»™ng trong mÃ´i trÆ°á»ng cá»§a chÃºng. 

Má»™t trong nhá»¯ng cÃ¡ch chÃ­nh lÃ  sá»­ dá»¥ng Tools Ä‘á»ƒ má»Ÿ rá»™ng kháº£ nÄƒng cá»§a model AI vÆ°á»£t ra ngoÃ i pháº¡m vi táº¡o vÄƒn báº£n.

Ta sáº½ tháº£o luáº­n thÃªm vá» message trong cÃ¡c chÆ°Æ¡ng tá»›i, nhÆ°ng náº¿u muá»‘n tÃ¬m hiá»ƒu sÃ¢u hÆ¡n ngay bÃ¢y giá», hÃ£y xem:

- <a href="https://huggingface.co/docs/transformers/main/en/chat_templating" target="_blank">HÆ°á»›ng dáº«n Chat Templating cá»§a Hugging Face</a>
- <a href="https://huggingface.co/docs/transformers" target="_blank">TÃ i liá»‡u Transformers</a>