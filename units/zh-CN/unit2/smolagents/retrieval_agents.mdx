<CourseFloatingBanner chapter={2}
  classNames="absolute z-10 right-0 top-0"
  notebooks={[
    {label: "Google Colab", value: "https://colab.research.google.com/github/huggingface/agents-course/blob/main/notebooks/unit2/smolagents/retrieval_agents.ipynb"},
]} />

# æ„å»ºæ™ºèƒ½é©±åŠ¨çš„ RAG ç³»ç»Ÿ

<Tip>
æ‚¨å¯ä»¥é€šè¿‡ <a href="https://huggingface.co/agents-course/notebooks/blob/main/unit2/smolagents/retrieval_agents.ipynb" target="_blank">æ­¤ Notebook</a> è·Ÿéšä»£ç å®è·µï¼Œè¯¥æ–‡ä»¶æ”¯æŒåœ¨ Google Colab ä¸­è¿è¡Œã€‚
</Tip>

æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRetrieval-Augmented Generationï¼ŒRAGï¼‰ç³»ç»Ÿç»“åˆäº†æ•°æ®æ£€ç´¢å’Œç”Ÿæˆæ¨¡å‹çš„èƒ½åŠ›ï¼Œä»¥æä¾›ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„å“åº”ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·çš„æŸ¥è¯¢ä¼šè¢«ä¼ é€’ç»™æœç´¢å¼•æ“ï¼Œæ£€ç´¢ç»“æœä¸æŸ¥è¯¢ä¸€èµ·æä¾›ç»™æ¨¡å‹ï¼Œæ¨¡å‹éšåæ ¹æ®æŸ¥è¯¢å’Œæ£€ç´¢åˆ°çš„ä¿¡æ¯ç”Ÿæˆå“åº”ã€‚

æ™ºèƒ½é©±åŠ¨çš„ RAGï¼ˆRetrieval-Augmented Generationï¼‰é€šè¿‡**å°†è‡ªä¸»æ™ºèƒ½ä½“ä¸åŠ¨æ€çŸ¥è¯†æ£€ç´¢ç›¸ç»“åˆ**ï¼Œæ‰©å±•äº†ä¼ ç»Ÿ RAG ç³»ç»Ÿã€‚

ä¼ ç»Ÿ RAG ç³»ç»Ÿä½¿ç”¨ LLM æ ¹æ®æ£€ç´¢æ•°æ®å›ç­”æŸ¥è¯¢ï¼Œè€Œæ™ºèƒ½é©±åŠ¨çš„ RAG **å®ç°äº†å¯¹æ£€ç´¢å’Œç”Ÿæˆæµç¨‹çš„æ™ºèƒ½æ§åˆ¶**ï¼Œä»è€Œæé«˜äº†æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚

ä¼ ç»Ÿ RAG ç³»ç»Ÿé¢ä¸´å…³é”®é™åˆ¶ï¼Œä¾‹å¦‚**ä¾èµ–å•æ¬¡æ£€ç´¢æ­¥éª¤**ï¼Œä»¥åŠè¿‡åº¦å…³æ³¨ä¸ç”¨æˆ·æŸ¥è¯¢çš„ç›´æ¥è¯­ä¹‰ç›¸ä¼¼æ€§ï¼Œè¿™å¯èƒ½ä¼šå¿½ç•¥ç›¸å…³ä¿¡æ¯ã€‚

æ™ºèƒ½é©±åŠ¨çš„ RAG é€šè¿‡å…è®¸æ™ºèƒ½ä½“è‡ªä¸»åˆ¶å®šæœç´¢æŸ¥è¯¢ã€è¯„ä¼°æ£€ç´¢ç»“æœå¹¶è¿›è¡Œå¤šæ¬¡æ£€ç´¢æ­¥éª¤ï¼Œä»¥ç”Ÿæˆæ›´å®šåˆ¶åŒ–å’Œå…¨é¢çš„è¾“å‡ºï¼Œä»è€Œè§£å†³è¿™äº›é—®é¢˜ã€‚

## åŸºäº DuckDuckGo çš„åŸºç¡€æ£€ç´¢

è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªèƒ½å¤Ÿä½¿ç”¨ DuckDuckGo è¿›è¡Œç½‘é¡µæœç´¢çš„ç®€å•æ™ºèƒ½ä½“ã€‚è¯¥æ™ºèƒ½ä½“å°†æ£€ç´¢ä¿¡æ¯å¹¶ç»¼åˆå“åº”æ¥å›ç­”æŸ¥è¯¢ã€‚é€šè¿‡æ™ºèƒ½é©±åŠ¨çš„ RAGï¼ŒAlfred çš„æ™ºèƒ½ä½“å¯ä»¥ï¼š

* æœç´¢æœ€æ–°çš„è¶…çº§è‹±é›„æ´¾å¯¹è¶‹åŠ¿
* ä¼˜åŒ–ç»“æœä»¥åŒ…å«å¥¢ä¾ˆå…ƒç´ 
* å°†ä¿¡æ¯ç»¼åˆæˆå®Œæ•´æ–¹æ¡ˆ

ä»¥ä¸‹æ˜¯ Alfred çš„æ™ºèƒ½ä½“å®ç°æ­¤åŠŸèƒ½çš„ä»£ç ç¤ºä¾‹ï¼š

```python
from smolagents import CodeAgent, DuckDuckGoSearchTool, HfApiModel

# åˆå§‹åŒ–æœç´¢å·¥å…·
search_tool = DuckDuckGoSearchTool()

# åˆå§‹åŒ–æ¨¡å‹
model = HfApiModel()

agent = CodeAgent(
    model=model,
    tools=[search_tool]
)

# ä½¿ç”¨ç¤ºä¾‹
response = agent.run(
    "Search for luxury superhero-themed party ideas, including decorations, entertainment, and catering."
)
print(response)
```

æ™ºèƒ½ä½“éµå¾ªä»¥ä¸‹æµç¨‹ï¼š

1. **è¯·æ±‚åˆ†æï¼š** Alfred çš„æ™ºèƒ½ä½“è¯†åˆ«æŸ¥è¯¢çš„å…³é”®è¦ç´ â€”â€”é‡ç‚¹å…³æ³¨è£…é¥°ã€å¨±ä¹å’Œé¤é¥®çš„è±ªåè¶…çº§è‹±é›„ä¸»é¢˜æ´¾å¯¹è§„åˆ’
2. **æ‰§è¡Œæ£€ç´¢ï¼š** æ™ºèƒ½ä½“åˆ©ç”¨ DuckDuckGo æœç´¢æœ€æ–°ç›¸å…³ä¿¡æ¯ï¼Œç¡®ä¿ç¬¦åˆ Alfred å¯¹å¥¢ä¾ˆæ´»åŠ¨çš„ç²¾ç»†è¦æ±‚
3. **ä¿¡æ¯ç»¼åˆï¼š** æ”¶é›†ç»“æœåï¼Œæ™ºèƒ½ä½“å°†å…¶å¤„ç†ä¸ºè¦†ç›–æ´¾å¯¹æ‰€æœ‰æ–¹é¢çš„å¯æ‰§è¡Œæ–¹æ¡ˆ
4. **æœªæ¥å‚è€ƒå­˜å‚¨ï¼š** æ™ºèƒ½ä½“å­˜å‚¨æ£€ç´¢ä¿¡æ¯ä»¥ä¾¿åç»­æ´»åŠ¨è§„åˆ’æ—¶å¿«é€Ÿè®¿é—®ï¼Œä¼˜åŒ–åç»­ä»»åŠ¡æ•ˆç‡

## è‡ªå®šä¹‰çŸ¥è¯†åº“å·¥å…·

å¯¹äºä¸“ä¸šä»»åŠ¡ï¼Œè‡ªå®šä¹‰çŸ¥è¯†åº“éå¸¸å®è´µã€‚è®©æˆ‘ä»¬åˆ›å»ºå¯ä»¥æŸ¥è¯¢æŠ€æœ¯æ–‡æ¡£æˆ–ä¸“ä¸šçŸ¥è¯†çš„å‘é‡æ•°æ®åº“å·¥å…·ã€‚é€šè¿‡è¯­ä¹‰æœç´¢ï¼Œæ™ºèƒ½ä½“å¯ä»¥æ‰¾åˆ°ä¸ Alfred éœ€æ±‚æœ€ç›¸å…³çš„ä¿¡æ¯ã€‚

å‘é‡æ•°æ®åº“ï¼ˆvector databaseï¼‰æ˜¯é€šè¿‡ä¸“ä¸š ML æ¨¡å‹å®ç°ä¸°å¯Œæ–‡æ¡£è¡¨ç¤ºçš„é›†åˆï¼Œèƒ½å¤Ÿå¿«é€Ÿæœç´¢å’Œæ£€ç´¢æ–‡æ¡£ã€‚

è¯¥æ–¹æ³•å°†é¢„å®šä¹‰çŸ¥è¯†ä¸è¯­ä¹‰æœç´¢ç›¸ç»“åˆï¼Œä¸ºæ´»åŠ¨è§„åˆ’æä¾›ä¸Šä¸‹æ–‡æ„ŸçŸ¥è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡ä¸“ä¸šçŸ¥è¯†è®¿é—®ï¼ŒAlfred å¯ä»¥å®Œå–„æ´¾å¯¹çš„æ¯ä¸ªç»†èŠ‚ã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä»è‡ªå®šä¹‰çŸ¥è¯†åº“æ£€ç´¢æ´¾å¯¹ç­–åˆ’åˆ›æ„çš„å·¥å…·ã€‚ä½¿ç”¨ BM25 æ£€ç´¢å™¨æœç´¢çŸ¥è¯†åº“å¹¶è¿”å›æœ€ä½³ç»“æœï¼ŒåŒæ—¶ä½¿ç”¨ `RecursiveCharacterTextSplitter` å°†æ–‡æ¡£åˆ†å‰²ä¸ºæ›´å°çš„å—ä»¥æé«˜æœç´¢æ•ˆç‡ï¼š

```python
from langchain.docstore.document import Document
from langchain.text_splitter import RecursiveCharacterTextSplitter
from smolagents import Tool
from langchain_community.retrievers import BM25Retriever
from smolagents import CodeAgent, HfApiModel

class PartyPlanningRetrieverTool(Tool):
    name = "party_planning_retriever"
    description = "Uses semantic search to retrieve relevant party planning ideas for Alfredâ€™s superhero-themed party at Wayne Manor."
    inputs = {
        "query": {
            "type": "string",
            "description": "The query to perform. This should be a query related to party planning or superhero themes.",
        }
    }
    output_type = "string"

    def __init__(self, docs, **kwargs):
        super().__init__(**kwargs)
        self.retriever = BM25Retriever.from_documents(
            docs, k=5  # æ£€ç´¢å‰ 5 ä¸ªæ–‡æ¡£
        )

    def forward(self, query: str) -> str:
        assert isinstance(query, str), "Your search query must be a string"

        docs = self.retriever.invoke(
            query,
        )
        return "\nRetrieved ideas:\n" + "".join(
            [
                f"\n\n===== Idea {str(i)} =====\n" + doc.page_content
                for i, doc in enumerate(docs)
            ]
        )

# æ¨¡æ‹Ÿæ´¾å¯¹ç­–åˆ’çŸ¥è¯†åº“
party_ideas = [
    {"text": "A superhero-themed masquerade ball with luxury decor, including gold accents and velvet curtains.", "source": "Party Ideas 1"},
    {"text": "Hire a professional DJ who can play themed music for superheroes like Batman and Wonder Woman.", "source": "Entertainment Ideas"},
    {"text": "For catering, serve dishes named after superheroes, like 'The Hulk's Green Smoothie' and 'Iron Man's Power Steak.'", "source": "Catering Ideas"},
    {"text": "Decorate with iconic superhero logos and projections of Gotham and other superhero cities around the venue.", "source": "Decoration Ideas"},
    {"text": "Interactive experiences with VR where guests can engage in superhero simulations or compete in themed games.", "source": "Entertainment Ideas"}
]

source_docs = [
    Document(page_content=doc["text"], metadata={"source": doc["source"]})
    for doc in party_ideas
]

# åˆ†å‰²æ–‡æ¡£ä»¥æé«˜æœç´¢æ•ˆç‡
    text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=50,
    add_start_index=True,
    strip_whitespace=True,
    separators=["\n\n", "\n", ".", " ", ""],
)
docs_processed = text_splitter.split_documents(source_docs)

# åˆ›å»ºæ£€ç´¢å·¥å…·
party_planning_retriever = PartyPlanningRetrieverTool(docs_processed)

# åˆå§‹åŒ–æ™ºèƒ½ä½“
agent = CodeAgent(tools=[party_planning_retriever], model=HfApiModel())

# ä½¿ç”¨ç¤ºä¾‹
response = agent.run(
    "Find ideas for a luxury superhero-themed party, including entertainment, catering, and decoration options."
)

print(response)
```

å¢å¼ºåçš„æ™ºèƒ½ä½“èƒ½å¤Ÿï¼š
1. é¦–å…ˆæ£€æŸ¥æ–‡æ¡£ä¸­çš„ç›¸å…³ä¿¡æ¯
2. ç»“åˆçŸ¥è¯†åº“çš„æ´å¯Ÿ
3. åœ¨å†…å­˜ä¸­ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡

## å¢å¼ºçš„æ£€ç´¢èƒ½åŠ›

æ„å»ºæ™ºèƒ½é©±åŠ¨çš„ RAG ç³»ç»Ÿæ—¶ï¼Œæ™ºèƒ½ä½“å¯ä»¥é‡‡ç”¨ä»¥ä¸‹é«˜çº§ç­–ç•¥ï¼š

1. **æŸ¥è¯¢é‡æ„ï¼š** æ™ºèƒ½ä½“å¯ä»¥ä¼˜åŒ–åŸå§‹æŸ¥è¯¢ï¼Œç”Ÿæˆæ›´åŒ¹é…ç›®æ ‡æ–‡æ¡£çš„æœç´¢è¯
2. **å¤šæ­¥æ£€ç´¢ï¼š** æ™ºèƒ½ä½“å¯ä»¥è¿›è¡Œå¤šæ¬¡æœç´¢ï¼Œåˆ©ç”¨åˆæ­¥ç»“æœä¼˜åŒ–åç»­æŸ¥è¯¢
3. **å¤šæºæ•´åˆï¼š** ç»“åˆæ¥è‡ªç½‘é¡µæœç´¢å’Œæœ¬åœ°æ–‡æ¡£ç­‰å¤šä¸ªæ¥æºçš„ä¿¡æ¯
4. **ç»“æœéªŒè¯ï¼š** åœ¨å°†æ£€ç´¢å†…å®¹çº³å…¥å“åº”å‰åˆ†æå…¶ç›¸å…³æ€§å’Œå‡†ç¡®æ€§

æœ‰æ•ˆçš„æ™ºèƒ½é©±åŠ¨ RAG ç³»ç»Ÿéœ€è¦ä»”ç»†è€ƒè™‘å‡ ä¸ªå…³é”®æ–¹é¢ã€‚æ™ºèƒ½ä½“**åº”æ ¹æ®æŸ¥è¯¢ç±»å‹å’Œä¸Šä¸‹æ–‡é€‰æ‹©å¯ç”¨å·¥å…·**ï¼Œè®°å¿†ç³»ç»Ÿå¸®åŠ©ç»´æŠ¤å¯¹è¯å†å²é¿å…é‡å¤æ£€ç´¢ï¼Œåå¤‡ç­–ç•¥ç¡®ä¿åœ¨ä¸»è¦æ£€ç´¢æ–¹æ³•å¤±è´¥æ—¶ç³»ç»Ÿä»èƒ½æä¾›ä»·å€¼ï¼ŒéªŒè¯æ­¥éª¤åˆ™å¸®åŠ©ç¡®ä¿æ£€ç´¢ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œç›¸å…³æ€§ã€‚

## èµ„æº

- [Agentic RAG: ä½¿ç”¨æŸ¥è¯¢é‡æ„å’Œè‡ªæŸ¥è¯¢åŠ é€Ÿæ‚¨çš„ RAG ç³»ç»Ÿï¼ğŸš€](https://huggingface.co/learn/cookbook/agent_rag) - ä½¿ç”¨ smolagents å¼€å‘æ™ºèƒ½é©±åŠ¨ RAG ç³»ç»Ÿçš„å®è·µæŒ‡å—
